// Generated by BUCKLESCRIPT, PLEASE EDIT WITH CARE
'use strict';

var $$Array = require("bs-platform/lib/js/array.js");
var Block = require("bs-platform/lib/js/block.js");
var Curry = require("bs-platform/lib/js/curry.js");
var Fetch = require("bs-fetch/src/Fetch.js");
var Types = require("./Types.bs.js");
var Future = require("reason-future/src/Future.bs.js");
var Js_dict = require("bs-platform/lib/js/js_dict.js");
var FutureJs = require("reason-future/src/FutureJs.bs.js");
var Caml_option = require("bs-platform/lib/js/caml_option.js");

((require('isomorphic-fetch')));

function makeConfig(poolId, clientId, region, $staropt$star, param) {
  var authenticationFlowType = $staropt$star !== undefined ? $staropt$star : /* USER_SRP_AUTH */1;
  return /* record */[
          /* poolId */poolId,
          /* clientId */clientId,
          /* endpoint */"https://cognito-idp." + (Types.makeRegionString(region) + ".amazonaws.com/"),
          /* authenticationFlowType */authenticationFlowType
        ];
}

function request(config, operation, params) {
  var headers = { };
  var target = "AWSCognitoIdentityProviderService." + Types.makeOperationString(operation);
  headers["X-Amz-Target"] = target;
  headers["Content-Type"] = "application/x-amz-json-1.1";
  headers["X-Amz-User-Agent"] = "reason-cognito/0.1.x js";
  params["ClientId"] = config[/* clientId */1];
  return Future.flatMapOk(FutureJs.fromPromise(fetch(config[/* endpoint */2], Fetch.RequestInit.make(/* Post */2, Caml_option.some(headers), Caml_option.some(JSON.stringify(params)), undefined, undefined, /* NoCORS */2, undefined, /* NoCache */3, undefined, undefined, undefined)(/* () */0)), (function (fetchError) {
                    return /* `CognitoClientError */[
                            -332319508,
                            fetchError
                          ];
                  })), (function (apiResponse) {
                return Future.flatMapOk(FutureJs.fromPromise(apiResponse.json(), (function (err) {
                                  return /* `CognitoJsonParseError */[
                                          -159238450,
                                          err
                                        ];
                                })), (function (json) {
                              var code = apiResponse.status;
                              var status = code < 200 ? /* Informational */Block.__(0, [code]) : (
                                  code >= 200 && code < 300 ? /* Success */Block.__(1, [code]) : (
                                      code >= 300 && code < 400 ? /* Redirect */Block.__(2, [code]) : (
                                          code >= 400 && code < 500 ? /* ClientError */Block.__(3, [code]) : /* ServerError */Block.__(4, [code])
                                        )
                                    )
                                );
                              return Future.make((function (resolve) {
                                            return Curry._1(resolve, /* Ok */Block.__(0, [/* record */[
                                                            /* status */status,
                                                            /* json */json
                                                          ]]));
                                          }));
                            }));
              }));
}

var Client = {
  request: request
};

function jsonMapString(arr) {
  return $$Array.map((function (item) {
                return Js_dict.map((function (value) {
                              return value;
                            }), item);
              }), arr);
}

function makeSignUpError(err, msg) {
  switch (err) {
    case "CodeDeliveryFailureException" :
        return /* `CognitoCodeDeliveryFailure */[
                307717752,
                msg
              ];
    case "InternalErrorException" :
        return /* `CognitoInternalError */[
                636052602,
                msg
              ];
    case "InvalidEmailRoleAccessPolicyException" :
        return /* `CognitoInvalidEmailRoleAccessPolicy */[
                -320011326,
                msg
              ];
    case "InvalidLambdaResponseException" :
        return /* `CognitoInvalidLambdaResponse */[
                -1072578002,
                msg
              ];
    case "InvalidParameterException" :
        return /* `CognitoInvalidParameter */[
                -267133469,
                msg
              ];
    case "InvalidPasswordException" :
        return /* `CognitoInvalidPassword */[
                -17702879,
                msg
              ];
    case "InvalidSmsRoleAccessPolicysException" :
        return /* `CognitoInvalidSmsRoleAccessPolicys */[
                598714580,
                msg
              ];
    case "InvalidSmsRoleTrustRelationshipException" :
        return /* `CognitoInvalidSmsRoleTrustRelationship */[
                -198400121,
                msg
              ];
    case "NotAuthorizedException" :
        return /* `CognitoNotAuthorized */[
                -1019683139,
                msg
              ];
    case "ResourceNotFoundException" :
        return /* `CognitoResourceNotFound */[
                281060686,
                msg
              ];
    case "TooManyRequestsException" :
        return /* `CognitoTooManyRequests */[
                165203366,
                msg
              ];
    case "UnexpectedLambdaException" :
        return /* `CognitoUnexpectedLambda */[
                -539579927,
                msg
              ];
    case "UserLambdaValidationException" :
        return /* `CognitoUserLambdaValidation */[
                1019055420,
                msg
              ];
    case "UsernameExistsException" :
        return /* `CognitoUsernameExists */[
                -157849469,
                msg
              ];
    default:
      return /* `CognitoUnknownError */[
              -55570033,
              msg
            ];
  }
}

function signUp(config, username, password, $staropt$star, $staropt$star$1, param) {
  var attributes = $staropt$star !== undefined ? $staropt$star : /* array */[];
  var validationData = $staropt$star$1 !== undefined ? $staropt$star$1 : /* array */[];
  var jsonAttribs = jsonMapString(attributes);
  var jsonVData = jsonMapString(validationData);
  var payload = { };
  payload["Username"] = username;
  payload["Password"] = password;
  payload["UserAttributes"] = jsonAttribs;
  payload["ValidationData"] = jsonVData;
  return Future.flatMapOk(request(config, /* SignUp */0, payload), (function (res) {
                var match = res[/* status */0];
                if (match.tag === /* Success */1) {
                  var cddDecoder = res.CodeDeliveryDetails;
                  var match$1 = cddDecoder.DeliveryMedium === "EMAIL";
                  var codeDeliveryDetails_000 = /* attributeName */cddDecoder.AttributeName;
                  var codeDeliveryDetails_001 = /* deliveryMedium */match$1 ? /* Email */0 : /* SMS */1;
                  var codeDeliveryDetails_002 = /* destination */cddDecoder.Destination;
                  var codeDeliveryDetails = /* record */[
                    codeDeliveryDetails_000,
                    codeDeliveryDetails_001,
                    codeDeliveryDetails_002
                  ];
                  return Future.make((function (resolve) {
                                return Curry._1(resolve, /* Ok */Block.__(0, [/* record */[
                                                /* codeDeliveryDetails */codeDeliveryDetails,
                                                /* userConfirmed */res.UserConfirmed,
                                                /* userSub */res.UserSub
                                              ]]));
                              }));
                } else {
                  var isErrorResponse = res[/* json */1];
                  var err = isErrorResponse.__type;
                  var msg = isErrorResponse.message;
                  var err$1 = makeSignUpError(err, msg);
                  return Future.make((function (resolve) {
                                return Curry._1(resolve, /* Error */Block.__(1, [err$1]));
                              }));
                }
              }));
}

function makeConfirmError(err, msg) {
  switch (err) {
    case "AliasExistsException" :
        return /* `CognitoAliasExists */[
                -498244869,
                msg
              ];
    case "CodeMismatchException" :
        return /* `CognitoCodeMismatch */[
                -817363892,
                msg
              ];
    case "ExpiredCodeException" :
        return /* `CognitoExpiredCode */[
                -64788767,
                msg
              ];
    case "InternalErrorException" :
        return /* `CognitoInternalError */[
                636052602,
                msg
              ];
    case "InvalidLambdaResponseException" :
        return /* `CognitoInvalidLambda */[
                -469073267,
                msg
              ];
    case "InvalidParameterException" :
        return /* `CognitoInvalidParameter */[
                -267133469,
                msg
              ];
    case "LimitExceededException" :
        return /* `CognitoLimitExceeded */[
                767083101,
                msg
              ];
    case "NotAuthorizedException" :
        return /* `CognitoNotAuthorized */[
                -1019683139,
                msg
              ];
    case "ResourceNotFoundException" :
        return /* `CognitoResourceNotFound */[
                281060686,
                msg
              ];
    case "TooManyFailedAttemptsException" :
        return /* `CognitoTooManyFailedAttempts */[
                261105285,
                msg
              ];
    case "TooManyRequestsException" :
        return /* `CognitoTooManyRequests */[
                165203366,
                msg
              ];
    case "UnexpectedLambdaException" :
        return /* `CognitoUnexpectedLambda */[
                -539579927,
                msg
              ];
    case "UserLambdaValidationException" :
        return /* `CognitoUserLambdaValidation */[
                1019055420,
                msg
              ];
    case "UserNotFoundException" :
        return /* `CognitoUserNotFound */[
                376697675,
                msg
              ];
    default:
      return /* `CognitoUnknownError */[
              -55570033,
              msg
            ];
  }
}

function confirmSignUp(config, username, confirmationCode, param) {
  var params = { };
  params["Username"] = username;
  params["ConfirmationCode"] = confirmationCode;
  return Future.flatMapOk(request(config, /* ConfirmSignUp */3, params), (function (res) {
                var match = res[/* status */0];
                if (match.tag === /* Success */1) {
                  return Future.make((function (resolve) {
                                return Curry._1(resolve, /* Ok */Block.__(0, [res]));
                              }));
                } else {
                  var isErrorResponse = res[/* json */1];
                  var err = isErrorResponse.__type;
                  var msg = isErrorResponse.message;
                  var err$1 = makeConfirmError(err, msg);
                  return Future.make((function (resolve) {
                                return Curry._1(resolve, /* Error */Block.__(1, [err$1]));
                              }));
                }
              }));
}

function initiateAuth(config, username, password, param) {
  var authParams = { };
  authParams["USERNAME"] = username;
  authParams["PASSWORD"] = password;
  var params = { };
  params["AuthParameters"] = authParams;
  params["AuthFlow"] = "USER_PASSWORD_AUTH";
  return Future.flatMapOk(request(config, /* InitiateAuth */8, params), (function (res) {
                var match = res[/* status */0];
                if (match.tag === /* Success */1) {
                  var authDecoder = res.AuthenticationResult;
                  var authenticationResult_000 = /* accessToken */authDecoder.AccessToken;
                  var authenticationResult_001 = /* expiresIn */authDecoder.ExpiresIn;
                  var authenticationResult_002 = /* idToken */authDecoder.IdToken;
                  var authenticationResult_003 = /* refreshToken */authDecoder.RefreshToken;
                  var authenticationResult_004 = /* tokenType */authDecoder.TokenType;
                  var authenticationResult = /* record */[
                    authenticationResult_000,
                    authenticationResult_001,
                    authenticationResult_002,
                    authenticationResult_003,
                    authenticationResult_004
                  ];
                  return Future.make((function (resolve) {
                                return Curry._1(resolve, /* Ok */Block.__(0, [/* record */[
                                                /* authenticationResult */authenticationResult,
                                                /* challengeParameters */res.ChallengeParameters
                                              ]]));
                              }));
                } else {
                  var isErrorResponse = res[/* json */1];
                  var err = isErrorResponse.__type;
                  var msg = isErrorResponse.message;
                  var err$1;
                  switch (err) {
                    case "InvalidParameterException" :
                        err$1 = /* `CognitoInvalidParameter */[
                          -267133469,
                          msg
                        ];
                        break;
                    case "NotAuthorizedException" :
                        err$1 = /* `CognitoNotAuthorized */[
                          -1019683139,
                          msg
                        ];
                        break;
                    default:
                      err$1 = /* `CognitoUnknownError */[
                        -55570033,
                        msg
                      ];
                  }
                  return Future.make((function (resolve) {
                                return Curry._1(resolve, /* Error */Block.__(1, [err$1]));
                              }));
                }
              }));
}

exports.makeConfig = makeConfig;
exports.Client = Client;
exports.jsonMapString = jsonMapString;
exports.makeSignUpError = makeSignUpError;
exports.signUp = signUp;
exports.makeConfirmError = makeConfirmError;
exports.confirmSignUp = confirmSignUp;
exports.initiateAuth = initiateAuth;
/*  Not a pure module */
